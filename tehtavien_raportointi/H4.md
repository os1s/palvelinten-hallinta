# Palvelinten hallinta H4

Tehtävä on tehty läppärillä josta löytyy Xubuntu 18.04 LTS ja pöytäkoneella josta löytyy
Windows 10 

Tehtävä on osa Tero Karvisen Palvelinten hallinta -kurssia:
http://terokarvinen.com/2018/aikataulu-%E2%80%93-palvelinten-hallinta-ict4tn022-3004-ti-ja-3$

### Skripti, joka tekee koneestasi salt-orjan

Kerkesin jo tunnilla tehdä yksinkertaisen skriptin, joka tekee koneesta salt-orjan.
Päätin kuitenkin tehdä tästä paremman version, joka soveltuu omiin tarkoituksiini paljon
paremmin.

```bash
#!/bin/bash
#salt-minion first time conf

HOSTNAME="$(hostname -I)"
#1 if salt-master is installed, 0 if not
MASTEREXISTS="$(dpkg-query -l | grep salt-master | wc -l)"
echo "input desired id for minion"
read SLAVE

sudo apt-get update
sudo apt-get -y install salt-minion

#checks if salt-master is installed, so we don't have to input hostname
#manually when installing minion and master on the same computer
if [ ${MASTEREXISTS} == 1 ]
then
	echo -e 'master: '$HOSTNAME'\nid: '$SLAVE|sudo tee /etc/salt/minion
else
	echo "enter master hostname"
	read MANUALHOSTNAME
	echo -e 'master: '$MANUALHOSTNAME'\nid: '$SLAVE|sudo tee /etc/salt/minion
fi
sudo systemctl restart salt-minion.service
echo 'Minion setup complete!'
```

Aina kun asennan salt-minionin, on se joko testimielessä samalle koneelle kuin
salt-master, jolloin skripti käyttää automaattisesti tietokoneen lokaalia ip-osoitetta.
Kun taas asennan salt-minionin koneelle, jossa ei ole salt-masteria, on salt-master
oletettavasti jossain toisella koneella, jolloin masterin ip pitää syöttää manuaalisesti.
Skripti ei todellakaan ole kaikkiin tarkoituksiin täydellinen, mutta sen tarkoitus
on helpottaa minun omaa minionin conffaus prosessia.

Kokeillaan toimiiko skripti, poistin ensin vanhan /etc/salt/minion tiedoston:
```
osku@bingobangobongo:/srv/salt/scripts$ sudo rm /etc/salt/minion
osku@bingobangobongo:/srv/salt/scripts$ cat /etc/salt/minion
cat: /etc/salt/minion: No such file or directory
osku@bingobangobongo:/srv/salt/scripts$ ./minionsetup.sh 
input desired id for minion
testiorja  
Hit:1 http://fi.archive.ubuntu.com/ubuntu bionic InRelease
Hit:2 http://fi.archive.ubuntu.com/ubuntu bionic-updates InRelease      
Hit:3 http://fi.archive.ubuntu.com/ubuntu bionic-backports InRelease    
Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
Reading package lists... Done                     
Reading package lists... Done
Building dependency tree       
Reading state information... Done
salt-minion is already the newest version (2017.7.4+dfsg1-1).
0 upgraded, 0 newly installed, 0 to remove and 167 not upgraded.
master: 192.168.42.183 
id: testiorja
Minion setup complete!
osku@bingobangobongo:/srv/salt/scripts$ hostname -I
192.168.42.183 
osku@bingobangobongo:/srv/salt/scripts$ cat /etc/salt/minion
master: 192.168.42.183 
id: testiorja
osku@bingobangobongo:/srv/salt/scripts$ sudo salt-key -A
The following keys are going to be accepted:
Unaccepted Keys:
testiorja
Proceed? [n/Y] y
Key for minion testiorja accepted.
```

Näyttäisi toimivan halutulla tavalla. Kokeilen seuraavassa tehtävässä skriptiä tuoreella virtuaalikoneella.

### Vagrantin asennus

Ensin asensin vagrantin ja virtualboxin:
```

```
